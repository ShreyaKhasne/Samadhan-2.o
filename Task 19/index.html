<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Social Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,Arial;margin:0;background:#f7fafc;color:#0f172a}
  .top{background:#111827;color:#fff;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
  .wrap{max-width:980px;margin:18px auto;padding:0 16px}
  .row{display:flex;gap:16px}
  .col-left{flex:1}
  .col-right{width:320px}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.06);margin-bottom:12px}
  textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e6;margin-top:8px}
  button{padding:8px 12px;border-radius:8px;border:0;background:#111827;color:#fff;cursor:pointer}
  .post{padding:10px;border-radius:8px;border:1px solid #eef2f7;margin-bottom:8px}
  .meta{font-size:13px;color:#6b7280}
  .small{font-size:13px;color:#6b7280}
  .link{color:#0b84ff;cursor:pointer}
  .likes{color:#ef4444;font-weight:600}
</style>
</head>
<body>
  <div class="top">
    <div style="font-weight:700">Social Dashboard</div>
    <div id="authArea"></div>
  </div>
  <div class="wrap">
    <div class="row">
      <div class="col-left">
        <div class="card">
          <textarea id="postContent" rows="3" placeholder="What's on your mind?"></textarea>
          <button id="createPostBtn">Post</button>
        </div>
        <div id="feed"></div>
      </div>
      <div class="col-right">
        <div class="card"><div style="font-weight:700">Profile</div><div id="profileBox"></div></div>
        <div class="card"><div style="font-weight:700">Explore Users</div><div id="usersList"></div></div>
      </div>
    </div>
  </div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
function el(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function setAuthArea(){
  const token = localStorage.getItem('token');
  const authArea = el('authArea');
  if (token) {
    fetch('/api/me', { headers: { Authorization: 'Bearer '+token } }).then(r=>r.json()).then(me=>{
      authArea.innerHTML = '<span>Hello, '+escapeHtml(me.display_name)+'</span> <button onclick="logout()">Logout</button>';
    });
  } else {
    authArea.innerHTML = '<button onclick="login()">Login</button> <button onclick="register()">Register</button>';
  }
}

function login(){
  const u = prompt("Username"); const p = prompt("Password");
  fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})})
  .then(r=>r.json()).then(d=>{ if(d.token){ localStorage.setItem('token', d.token); setAuthArea(); loadFeed(); }});
}

function register(){
  const u = prompt("Username"); const p = prompt("Password");
  fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})})
  .then(r=>r.json()).then(d=>{ if(d.token){ localStorage.setItem('token', d.token); setAuthArea(); loadFeed(); }});
}

function logout(){ localStorage.removeItem('token'); setAuthArea(); }

function loadFeed(){
  fetch('/api/feed').then(r=>r.json()).then(posts=>{
    const feed = el('feed'); feed.innerHTML='';
    posts.forEach(p=>{
      const div=document.createElement('div'); div.className='post';
      div.innerHTML='<b>'+escapeHtml(p.display_name)+'</b>: '+escapeHtml(p.content)+'<br><span class="small">'+p.like_count+' ‚ù§ | '+p.comment_count+' üí¨</span>';
      feed.appendChild(div);
    });
  });
}

el('createPostBtn').onclick=()=>{
  const token = localStorage.getItem('token'); if(!token) return alert("Login first");
  const content = el('postContent').value;
  fetch('/api/posts',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({content})})
  .then(()=>{el('postContent').value=''; loadFeed();});
}

setAuthArea(); loadFeed();
const socket = io();
socket.on("new-post", loadFeed);
socket.on("new-comment", loadFeed);
socket.on("like-toggled", loadFeed);
</script>
</body>
</html>
